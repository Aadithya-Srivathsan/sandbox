import os
import azure.functions as func
from openai import AzureOpenAI

app = func.FunctionApp(http_auth_level=func.AuthLevel.ANONYMOUS)

# Initialize Azure OpenAI client using ENV variables
client = AzureOpenAI(
    azure_endpoint=os.environ["OPENAI_ENDPOINT"],
    api_key=os.environ["OPENAI_API_KEY"],
    api_version="2025-03-01-preview",  # same as your local
)

@app.route(route="chat", methods=["GET"])
def chat(req: func.HttpRequest) -> func.HttpResponse:
    user_message = req.params.get("message")

    if not user_message:
        return func.HttpResponse(
            "Please pass ?message=hello",
            status_code=400
        )

    try:
        response = client.responses.create(
            model=os.environ["OPENAI_DEPLOYMENT_NAME"],
            input=[
                {"role": "user", "content": user_message}
            ],
        )

        reply = response.output[0].content[0].text
        return func.HttpResponse(reply, status_code=200)

    except Exception as e:
        return func.HttpResponse(
            f"Error: {str(e)}",
            status_code=500
        )
