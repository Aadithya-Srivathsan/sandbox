main.tf

provider "azurerm" {
  features {}
  subscription_id = var.subscription_id
}

data "azurerm_resource_group" "existing_rg" {
  name = var.resource_group_name
}

resource "azurerm_virtual_network" "vnet" {
  name                = "genai-vnet"
  location            = data.azurerm_resource_group.existing_rg.location
  resource_group_name = data.azurerm_resource_group.existing_rg.name
  address_space       = ["10.10.0.0/16"]
}

resource "azurerm_subnet" "subnet" {
  name                 = "genai-subnet"
  resource_group_name  = data.azurerm_resource_group.existing_rg.name
  virtual_network_name = azurerm_virtual_network.vnet.name
  address_prefixes     = ["10.10.1.0/24"]
}

resource "azurerm_network_interface" "nic" {
  name                = "genai-nic"
  location            = data.azurerm_resource_group.existing_rg.location
  resource_group_name = data.azurerm_resource_group.existing_rg.name

  ip_configuration {
    name                          = "internal"
    subnet_id                     = azurerm_subnet.subnet.id
    private_ip_address_allocation = "Dynamic"
  }
}

resource "azurerm_linux_virtual_machine" "vm" {
  name                = "genai-chatbot-vm"
  location            = data.azurerm_resource_group.existing_rg.location
  resource_group_name = data.azurerm_resource_group.existing_rg.name
  size                = "Standard_B1s"
  admin_username      = var.admin_username

  network_interface_ids = [
    azurerm_network_interface.nic.id
  ]

  admin_ssh_key {
    username   = var.admin_username
    public_key = file(var.ssh_public_key_path)
  }

  custom_data = base64encode(<<EOF
#!/bin/bash
apt update
apt install -y python3 python3-pip
pip3 install flask openai

echo "OPENAI_ENDPOINT=${var.openai_endpoint}" >> /etc/environment
echo "OPENAI_API_KEY=${var.openai_api_key}" >> /etc/environment
echo "OPENAI_DEPLOYMENT_NAME=${var.openai_deployment_name}" >> /etc/environment
EOF
  )

  os_disk {
    caching              = "ReadWrite"
    storage_account_type = "Standard_LRS"
  }

  source_image_reference {
    publisher = "Canonical"
    offer     = "0001-com-ubuntu-server-jammy"
    sku       = "22_04-lts"
    version   = "latest"
  }

  tags = {
    project = "genai-chatbot"
  }
}

##########################################################
variables.tf

variable "subscription_id" {
  description = "Azure sandbox subscription ID"
  type        = string
}

variable "resource_group_name" {
  description = "Existing Resource Group name"
  type        = string
}

variable "location" {
  description = "Azure region"
  type        = string
}

variable "admin_username" {
  type    = string
  default = "azureuser"
}

variable "ssh_public_key_path" {
  type    = string
  default = "~/.ssh/id_rsa.pub"
}

# Azure OpenAI
variable "openai_endpoint" {
  type = string
}

variable "openai_api_key" {
  type      = string
  sensitive = true
}

variable "openai_deployment_name" {
  type = string
}

#################################################################
terraform.tfvars
subscription_id     = "08b45153-8a8b-4480-88e4-0c0406cdee1b"
resource_group_name = "Gen-AI-RG"
location            = "eastus"

openai_endpoint        = "https://learning-openai.openai.azure.com/"
openai_api_key         = "PASTE_YOUR_OPENAI_KEY"
openai_deployment_name = "gpt-4o-mini"

#######################################################################
output.tf
output "vm_private_ip" {
  value = azurerm_network_interface.nic.private_ip_address
}

output "vm_name" {
  value = azurerm_linux_virtual_machine.vm.name
}

#############################################################################
app/requirements.txt

flask
openai

#############################################################################
app/app.py

import os
from flask import Flask, request, render_template
from openai import AzureOpenAI

app = Flask(__name__)

client = AzureOpenAI(
    azure_endpoint=os.environ["OPENAI_ENDPOINT"],
    api_key=os.environ["OPENAI_API_KEY"],
    api_version="2024-02-15-preview"
)

@app.route("/", methods=["GET", "POST"])
def chat():
    reply = ""
    if request.method == "POST":
        msg = request.form.get("message")

        response = client.chat.completions.create(
            model=os.environ["OPENAI_DEPLOYMENT_NAME"],
            messages=[
                {"role": "system", "content": "You are a helpful assistant."},
                {"role": "user", "content": msg}
            ],
            max_tokens=300
        )

        reply = response.choices[0].message.content

    return render_template("index.html", reply=reply)

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000)
  
####################################################

  app/templates/index.html

  <!DOCTYPE html>
<html>
<head>
  <title>GenAI Chatbot</title>
  <link rel="stylesheet" href="/static/style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <div class="chat-container">
    <h2>GenAI Chatbot</h2>
    <form method="POST">
      <input type="text" name="message" placeholder="Ask something..." required>
      <button type="submit">Send</button>
    </form>

    {% if reply %}
    <div class="reply">{{ reply }}</div>
    {% endif %}
  </div>
</body>
</html>

###########################################################################
  app/static/style.css

      body {
  font-family: Arial, sans-serif;
  background: #f4f6f8;
}

.chat-container {
  max-width: 500px;
  margin: 10% auto;
  background: white;
  padding: 20px;
  border-radius: 10px;
}

input {
  width: 75%;
  padding: 10px;
}

button {
  padding: 10px;
}

.reply {
  margin-top: 20px;
  background: #eef1f5;
  padding: 10px;
  border-radius: 5px;
}

      ##################################################################
      
      
